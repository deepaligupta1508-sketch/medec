<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeLine | Unified Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1a73e8; --secondary: #34a853; --danger: #ea4335; --dark: #202124; --light: #f8f9fa; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { display: flex; height: 100vh; background-color: var(--light); color: var(--dark); }

        /* Sidebar Navigation */
        .sidebar { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; transition: 0.3s; }
        .sidebar h2 { text-align: center; margin-bottom: 30px; letter-spacing: 2px; }
        .nav-item { padding: 15px; margin: 5px 0; display: flex; align-items: center; cursor: pointer; border-radius: 8px; color: rgba(255,255,255,0.8); text-decoration: none; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.2); color: white; }
        .nav-item i { margin-right: 15px; width: 20px; text-align: center; }

        /* Content Area */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
        .section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .section.active { display: block; }

        /* Dashboard Cards */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 4px solid var(--primary); }
        .bed-count { font-size: 2rem; font-weight: bold; color: var(--primary); }

        /* Hospital Controls */
        .controls { display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background: var(--secondary); }
        .btn-remove { background: var(--danger); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h2>LIFELINE</h2>
        <a href="#" class="nav-item active" onclick="showTab('home')"><i class="fas fa-home"></i> Dashboard</a>
        <a href="#" class="nav-item" onclick="showTab('profile')"><i class="fas fa-user"></i> Profile</a>
        <a href="#" class="nav-item" onclick="showTab('hospitals')"><i class="fas fa-hospital"></i> Hospital List</a>
        <a href="#" class="nav-item" id="manage-nav" style="display: none;" onclick="showTab('manage')"><i class="fas fa-edit"></i> Manage Beds</a>
        <a href="#" class="nav-item" onclick="showTab('pricing')"><i class="fas fa-tags"></i> Pricing</a>
        <a href="#" class="nav-item" onclick="showTab('contact')"><i class="fas fa-envelope"></i> Contact</a>
        <a href="login.html" class="nav-item" style="margin-top: auto; color: #ffbcbc;"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>

    <main class="main-content">
        <header class="header">
            <div>
                <h1 id="welcome-msg">Welcome, User</h1>
                <p id="role-badge" style="color: #666; font-weight: bold;"></p>
            </div>
            <div class="user-meta">
                <i class="fas fa-bell" style="margin-right: 20px; cursor: pointer;"></i>
                <img id="user-avatar" src="https://ui-avatars.com/api/?name=User" alt="Avatar" style="border-radius: 50%; width: 45px;">
            </div>
        </header>

        <div id="home" class="section active">
            <div class="card-grid">
                <div class="card">
                    <h3>Live Bed Status</h3>
                    <p>Total beds available across all facilities.</p>
                    <div class="bed-count" id="total-beds-summary">0</div>
                </div>
                <div class="card">
                    <h3>Emergency Contact</h3>
                    <p>Immediate medical assistance: <strong>102</strong></p>
                </div>
            </div>
        </div>

        <div id="profile" class="section">
            <div class="card">
                <h2>My Profile</h2>
                <hr style="margin: 15px 0;">
                <p><strong>Name:</strong> <span id="prof-name"></span></p>
                <p><strong>Email:</strong> <span id="prof-email"></span></p>
                <p><strong>Account Type:</strong> <span id="prof-role"></span></p>
            </div>
        </div>

        <div id="hospitals" class="section">
            <h2 style="margin-bottom: 20px;">Available Hospitals</h2>
            <div id="public-hospital-list" class="card-grid"></div>
        </div>

        <div id="manage" class="section">
            <h2>Hospital Management Console</h2>
            <p style="margin-bottom: 20px;">Update your live bed inventory here.</p>
            <div id="admin-hospital-list" class="card-grid"></div>
        </div>

        <div id="pricing" class="section">
            <h2>Service Pricing</h2>
            <div class="card-grid">
                <div class="card"><h3>General Ward</h3><p>₹1,200 / day</p></div>
                <div class="card"><h3>ICU Facility</h3><p>₹5,000 / day</p></div>
                <div class="card"><h3>Oxygen Bed</h3><p>₹2,500 / day</p></div>
            </div>
        </div>

        <div id="contact" class="section">
            <div class="card">
                <h2>Contact Us</h2>
                <p>Email: support@lifeline.com</p>
                <p>Helpline: +91 9988776655</p>
                <p>Location: Mumbai, Maharashtra</p>
            </div>
        </div>
    </main>

    <script>
        // Use data stored during handleLogin()
        const user = {
            name: localStorage.getItem('userName') || "Guest",
            role: localStorage.getItem('userRole') || "patient",
            email: localStorage.getItem('userEmail') || "N/A"
        };

        function initDashboard() {
            document.getElementById('welcome-msg').innerText = `Hello, ${user.name}`;
            document.getElementById('role-badge').innerText = `ACCESS: ${user.role.toUpperCase()}`;
            document.getElementById('prof-name').innerText = user.name;
            document.getElementById('prof-email').innerText = user.email;
            document.getElementById('prof-role').innerText = user.role;
            document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${user.name}&background=1a73e8&color=fff`;

            // Hospital-only feature
            if(user.role === 'hospital') {
                document.getElementById('manage-nav').style.display = 'flex';
            }
            fetchHospitals();
        }

        function showTab(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function fetchHospitals() {
            try {
                const res = await fetch('http://localhost:5000/api/hospitals');
                const data = await res.json();
                
                const publicList = document.getElementById('public-hospital-list');
                const adminList = document.getElementById('admin-hospital-list');
                let total = 0;

                publicList.innerHTML = '';
                adminList.innerHTML = '';

                data.forEach(h => {
                    total += h.beds;
                    // Patient View
                    publicList.innerHTML += `
                        <div class="card">
                            <h3>${h.name}</h3>
                            <p>Location: Mumbai Region</p>
                            <div class="bed-count">${h.beds}</div>
                            <small>Beds Available Now</small>
                        </div>`;
                    
                    // Hospital Management View
                    adminList.innerHTML += `
                        <div class="card">
                            <h3>${h.name}</h3>
                            <div class="bed-count" id="bed-val-${h.id}">${h.beds}</div>
                            <div class="controls">
                                <button class="btn btn-add" onclick="updateBed(${h.id}, 1)">+ Add</button>
                                <button class="btn btn-remove" onclick="updateBed(${h.id}, -1)">- Remove</button>
                            </div>
                        </div>`;
                });
                document.getElementById('total-beds-summary').innerText = total;
            } catch (e) { 
                console.error("Backend connection failed."); 
            }
        }

        async function updateBed(id, change) {
            try {
                const response = await fetch('http://localhost:5000/api/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id, change })
                });
                if (response.ok) fetchHospitals(); // Refresh numbers
            } catch (err) {
                alert("Could not update. Is the server running?");
            }
        }

        initDashboard();
        setInterval(fetchHospitals, 5000); // Live updates
    </script>
</body>
</html>
